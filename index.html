<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Robo Control! ðŸš€</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <style>
        :root { --frente: #00ff88; --tras: #ffea00; --lados: #00d9ff; --parar: #ff3131; }
        body { background: #000; color: white; font-family: 'Arial Rounded MT Bold', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { padding: 15px; background: #1a1a1a; border-bottom: 4px solid #333; display: flex; justify-content: space-around; align-items: center; }
        #btn-conectar { background: var(--frente); border: none; padding: 15px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px #00a85a; }
        #txt-comando { font-size: 3.5rem; margin: 15px 0; color: var(--parar); text-align: center; }
        .controles { flex-grow: 1; display: flex; flex-direction: column; justify-content: space-around; align-items: center; }
        .caixa-slider { background: #222; width: 85%; padding: 10px; border-radius: 15px; border: 2px solid #444; }
        input[type=range] { width: 100%; height: 20px; accent-color: var(--lados); }
        #joystick-zone { width: 200px; height: 200px; }
    </style>
</head>
<body>

<header>
    <button id="btn-conectar" onclick="conectarForÃ§ado()">BUSCAR ROBÃ” ðŸ¤–</button>
    <p id="status" style="font-size: 0.7rem; color: #888;">Desconectado</p>
</header>

<div class="controles">
    <h1 id="txt-comando">PARADO</h1>

    <div class="caixa-slider">
        <label>VELOCIDADE: <b id="val-v">150</b></label>
        <input type="range" min="0" max="255" value="150" oninput="ajustar('V', this.value, 'val-v')">
    </div>

    <div id="joystick-zone"></div>

    <div class="caixa-slider" style="border-color: #bc13fe;">
        <label>ALTURA PINO: <b id="val-h">90</b>Â°</label>
        <input type="range" min="0" max="180" value="90" oninput="ajustar('H', this.value, 'val-h')">
    </div>
</div>

<script>
    let gattChar = null;
    // O UUID que o HC-05 usa para se comunicar
    const SERVICE_UUID = 0xFFE0; // ServiÃ§o comum para mÃ³dulos seriais chineses
    const CHAR_UUID = 0xFFE1;    // CaracterÃ­stica de escrita

    async function conectarForÃ§ado() {
        const statusTxt = document.getElementById('status');
        try {
            statusTxt.innerText = "Procurando sinal...";
            
            // MudanÃ§a estratÃ©gica: Pedimos por todos, mas focamos nos serviÃ§os de dados
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [SERVICE_UUID, '00001101-0000-1000-8000-00805f9b34fb']
            });

            statusTxt.innerText = "Pareando rÃ¡dio...";
            const server = await device.gatt.connect();
            
            statusTxt.innerText = "Acessando comandos...";
            // Tentamos o serviÃ§o primÃ¡rio FFE0 (comum no HC-05 moderno/BLE)
            const service = await server.getPrimaryService(SERVICE_UUID);
            gattChar = await service.getCharacteristic(CHAR_UUID);

            document.getElementById('btn-conectar').innerText = "CONECTADO! ðŸš€";
            document.getElementById('btn-conectar').style.background = "#2196f3";
            statusTxt.innerText = "Pronto!";
        } catch (e) {
            console.error(e);
            statusTxt.innerText = "Erro: " + e.message;
            // Se o erro for de UUID nÃ£o encontrado, tentaremos o Bluetooth clÃ¡ssico
            alert("Se o HC-05 aparecer na lista, mas der erro de UUID, seu modelo de HC-05 nÃ£o suporta Web Bluetooth nativo no Chromebook.");
        }
    }

    async function enviar(cmd) {
        if (gattChar) {
            try {
                const encoder = new TextEncoder();
                await gattChar.writeValue(encoder.encode(cmd + '\n'));
                if(cmd.length === 1) document.getElementById('txt-comando').innerText = traduzir(cmd);
            } catch (e) { console.log("Falha no sinal"); }
        }
    }

    function ajustar(prefixo, valor, labelId) {
        document.getElementById(labelId).innerText = valor;
        enviar(prefixo + valor);
    }

    function traduzir(c) {
        const t = {'F':'FRENTE', 'B':'RÃ‰', 'L':'ESQUERDA', 'R':'DIREITA', 'S':'PARADO'};
        return t[c] || c;
    }

    // Joystick Setup
    const joy = nipplejs.create({ zone: document.getElementById('joystick-zone'), mode: 'static', position: {left: '50%', top: '50%'}, color: 'white', size: 150 });
    joy.on('dir:up', () => enviar('F')); joy.on('dir:down', () => enviar('B'));
    joy.on('dir:left', () => enviar('L')); joy.on('dir:right', () => enviar('R'));
    joy.on('end', () => enviar('S'));
</script>
</body>
</html>
