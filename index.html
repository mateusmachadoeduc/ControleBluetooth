<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Robo Control! ðŸš€</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <style>
        :root { --cor-frente: #00ff88; --cor-lados: #00d9ff; --cor-parar: #ff3131; }
        body { background: #000; color: white; font-family: sans-serif; text-align: center; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { padding: 20px; background: #1a1a1a; border-bottom: 4px solid #333; }
        #btn-conectar { background: var(--cor-frente); border: none; padding: 15px 30px; border-radius: 50px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        #txt-comando { font-size: 4rem; margin: 20px 0; color: var(--cor-parar); }
        .caixa { background: #1a1a1a; margin: 10px; padding: 15px; border-radius: 15px; border: 2px solid #333; }
        .container { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
        input[type=range] { width: 80%; height: 20px; }
    </style>
</head>
<body>

<header>
    <button id="btn-conectar" onclick="conectarSerial()">CONECTAR VIA SERIAL ðŸ”Œ</button>
</header>

<div id="painel">
    <p style="color: #888; margin-top: 10px;">COMANDO ATUAL:</p>
    <h1 id="txt-comando">PARADO</h1>
</div>

<div class="caixa">
    <label>POTÃŠNCIA: <b id="val-v">150</b></label><br>
    <input type="range" min="0" max="255" value="150" oninput="ajustarV(this.value)">
</div>

<div class="container">
    <div id="joystick" style="width: 200px; height: 200px;"></div>
</div>

<script>
    let port, writer;

    async function conectarSerial() {
        try {
            // Isso abrirÃ¡ uma lista. O HC-05 deve aparecer nela se estiver pareado!
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            
            writer = port.writable.getWriter();
            document.getElementById('btn-conectar').innerText = "CONECTADO! ðŸš€";
            document.getElementById('btn-conectar').style.background = "#2196f3";
        } catch (e) {
            alert("Erro Serial: " + e.message + "\n\nDica: Pareie o HC-05 no sistema antes.");
        }
    }

    async function enviar(c) {
        document.getElementById('txt-comando').innerText = c;
        if (writer) {
            const data = new TextEncoder().encode(c + '\n');
            await writer.write(data);
        }
    }

    function ajustarV(v) { 
        document.getElementById('val-v').innerText = v; 
        enviar('V' + v); 
    }

    const joy = nipplejs.create({ zone: document.getElementById('joystick'), mode: 'static', position: {left: '50%', top: '50%'}, color: 'white', size: 150 });
    joy.on('dir:up', () => enviar('F'));
    joy.on('dir:down', () => enviar('B'));
    joy.on('dir:left', () => enviar('L'));
    joy.on('dir:right', () => enviar('R'));
    joy.on('end', () => enviar('S'));

    window.addEventListener('keydown', (e) => {
        const k = { 'ArrowUp':'F', 'ArrowDown':'B', 'ArrowLeft':'L', 'ArrowRight':'R', ' ':'S' };
        if(k[e.key]) enviar(k[e.key]);
    });
    window.addEventListener('keyup', () => enviar('S'));
</script>
</body>
</html>
