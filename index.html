<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Robo Control! ðŸš€</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <style>
        :root {
            --cor-frente: #00ff88;
            --cor-tras: #ffea00;
            --cor-lados: #00d9ff;
            --cor-parar: #ff3131;
            --cor-pino: #bc13fe;
        }

        body { 
            background: #000; color: white; font-family: 'Arial Rounded MT Bold', sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        header { 
            padding: 10px; display: flex; justify-content: space-around; align-items: center; 
            background: #1a1a1a; border-bottom: 4px solid #333;
        }

        #btn-conectar { 
            background: var(--cor-frente); border: none; padding: 10px 20px; border-radius: 50px;
            font-size: 1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px #00a85a;
        }

        #painel-comando {
            background: #222; margin: 10px; padding: 10px; border-radius: 20px;
            border: 4px solid #444; text-align: center;
        }
        #txt-comando { font-size: 3rem; margin: 0; color: var(--cor-parar); transition: 0.2s; }

        .caixa-ajuste { background: #1a1a1a; padding: 8px; margin: 5px 15px; border-radius: 12px; border: 2px solid #333; }
        input[type=range] { width: 100%; height: 15px; cursor: pointer; }

        .container-controles { flex-grow: 1; display: flex; justify-content: center; align-items: center; }

        .grid-botoes { display: grid; grid-template-columns: repeat(3, 85px); gap: 10px; }
        .btn-game { 
            width: 85px; height: 85px; border-radius: 18px; border: none; 
            font-size: 2rem; color: white; cursor: pointer; background: #333;
            box-shadow: 0 5px #1a1a1a;
        }
        .btn-game:active { transform: translateY(3px); box-shadow: 0 2px #1a1a1a; }
        
        .btn-f { background: var(--cor-frente); }
        .btn-b { background: var(--cor-tras); color: #000; }
        .btn-l, .btn-r { background: var(--cor-lados); }
        .btn-s { background: var(--cor-parar); }

        .modo-switch { background: #333; border-radius: 30px; padding: 5px; display: flex; }
        .btn-modo { background: none; border: none; color: white; padding: 5px 12px; border-radius: 20px; cursor: pointer; }
        .modo-ativo { background: var(--cor-lados); font-weight: bold; }
        .escondido { display: none !important; }
    </style>
</head>
<body>

<header>
    <button id="btn-conectar" onclick="conectarBT()">LIGAR ROBÃ” ðŸ¤–</button>
    <div class="modo-switch">
        <button id="m-pad" class="btn-modo modo-ativo" onclick="mudarModo('pad')">PAD</button>
        <button id="m-btn" class="btn-modo" onclick="mudarModo('btn')">BOTÃ•ES</button>
    </div>
</header>

<div id="painel-comando">
    <h1 id="txt-comando">PARADO</h1>
    <p id="txt-status" style="margin:0; font-size:0.8rem; color:#888;">Bluetooth Desconectado</p>
</div>

<div class="caixa-ajuste" style="border-color: var(--cor-lados);">
    <label style="font-size:0.8rem;">VELOCIDADE: <b id="val-v">150</b></label>
    <input type="range" min="0" max="255" value="150" oninput="ajustarV(this.value)">
</div>
<div class="caixa-ajuste" style="border-color: var(--cor-pino);">
    <label style="font-size:0.8rem;">ALTURA PINO: <b id="val-h">90</b>Â°</label>
    <input type="range" min="0" max="180" value="90" oninput="ajustarH(this.value)">
</div>

<div class="container-controles">
    <div id="area-joystick" style="width: 180px; height: 180px;"></div>
    <div id="area-botoes" class="grid-botoes escondido">
        <div></div> <button class="btn-game btn-f" onmousedown="enviar('F')" onmouseup="enviar('S')" ontouchstart="enviar('F')" ontouchend="enviar('S')">â–²</button> <div></div>
        <button class="btn-game btn-l" onmousedown="enviar('L')" onmouseup="enviar('S')" ontouchstart="enviar('L')" ontouchend="enviar('S')">â—€</button>
        <button class="btn-game btn-s" onclick="enviar('S')">â– </button>
        <button class="btn-game btn-r" onmousedown="enviar('R')" onmouseup="enviar('S')" ontouchstart="enviar('R')" ontouchend="enviar('S')">â–¶</button>
        <div></div> <button class="btn-game btn-b" onmousedown="enviar('B')" onmouseup="enviar('S')" ontouchstart="enviar('B')" ontouchend="enviar('S')">â–¼</button> <div></div>
    </div>
</div>

<script>
    let device, char;
    // UUID Serial PadrÃ£o para HC-05 (Bluetooth Classic SPP)
    const SERIAL_UUID = '00001101-0000-1000-8000-00805f9b34fb';

    const infos = {
        'F': { t: 'FRENTE', c: 'var(--cor-frente)' },
        'B': { t: 'RÃ‰', c: 'var(--cor-tras)' },
        'L': { t: 'ESQUERDA', c: 'var(--cor-lados)' },
        'R': { t: 'DIREITA', c: 'var(--cor-lados)' },
        'S': { t: 'PARADO', c: 'var(--cor-parar)' }
    };

    async function conectarBT() {
        const btn = document.getElementById('btn-conectar');
        const status = document.getElementById('txt-status');
        try {
            status.innerText = "Buscando RobÃ´...";
            // Filtro focado no ServiÃ§o Serial
            device = await navigator.bluetooth.requestDevice({
                filters: [{ services: [SERIAL_UUID] }],
                optionalServices: [SERIAL_UUID]
            });

            status.innerText = "Conectando...";
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERIAL_UUID);
            char = await service.getCharacteristic(SERIAL_UUID);
            
            btn.innerText = "CONECTADO! ðŸš€";
            btn.style.background = "#2196f3";
            status.innerText = "RobÃ´ pronto!";

            device.addEventListener('gattserverdisconnected', () => {
                btn.innerText = "LIGAR ROBÃ” ðŸ¤–";
                btn.style.background = "var(--cor-frente)";
                status.innerText = "ConexÃ£o perdida!";
                char = null;
            });
        } catch (e) {
            console.error(e);
            status.innerText = "Erro ao conectar.";
            alert("Certifique-se de que o HC-05 NÃƒO estÃ¡ pareado nas configuraÃ§Ãµes do Chromebook antes de clicar aqui.");
        }
    }

    async function enviar(c) {
        if(infos[c]) {
            const display = document.getElementById('txt-comando');
            display.innerText = infos[c].t;
            display.style.color = infos[c].c;
            display.style.textShadow = `0 0 20px ${infos[c].c}`;
        }
        if (char) {
            try {
                const enc = new TextEncoder();
                // Enviamos com \n para o Arduino saber onde o comando termina
                await char.writeValue(enc.encode(c + '\n'));
            } catch (e) { console.log("Erro de envio"); }
        }
    }

    function ajustarV(v) { document.getElementById('val-v').innerText = v; enviar('V' + v); }
    function ajustarH(h) { document.getElementById('val-h').innerText = h; enviar('H' + h); }

    function mudarModo(m) {
        document.getElementById('area-joystick').classList.toggle('escondido', m === 'btn');
        document.getElementById('area-botoes').classList.toggle('escondido', m === 'pad');
        document.getElementById('m-pad').classList.toggle('modo-ativo', m === 'pad');
        document.getElementById('m-btn').classList.toggle('modo-ativo', m === 'btn');
        enviar('S');
    }

    const joy = nipplejs.create({ zone: document.getElementById('area-joystick'), mode: 'static', position: {left: '50%', top: '50%'}, color: 'white', size: 130 });
    joy.on('dir:up', () => enviar('F')); joy.on('dir:down', () => enviar('B'));
    joy.on('dir:left', () => enviar('L')); joy.on('dir:right', () => enviar('R'));
    joy.on('end', () => enviar('S'));

    window.addEventListener('keydown', (e) => {
        const k = { 'ArrowUp':'F', 'ArrowDown':'B', 'ArrowLeft':'L', 'ArrowRight':'R', ' ':'S' };
        if(k[e.key]) enviar(k[e.key]);
    });
    window.addEventListener('keyup', (e) => { if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) enviar('S'); });
</script>
</body>
</html>
